# 澜鳐控制终端技术文档

## 1. 项目概述

澜鳐控制终端是一款基于 Electron + Vue 开发的桌面应用程序，用于连接澜鳐物联网网关，实现对各类物联网设备的集中控制与管理。该终端仿照智能家居平台设计，提供直观的设备控制界面、实时状态监控、历史日志查询等功能。支持纯局域网连接模式，无需公网，适用于无网络连接环境与实验室要求主机不得联网的保密环境。

### 1.1 主要功能

- **设备管理**：添加、删除、编辑物联网设备
- **设备控制**：实时控制设备开关、调节参数
- **状态监控**：实时显示设备运行状态
- **日志管理**：查看设备操作日志、系统日志
- **网关管理**：连接、配置物联网网关
- **用户管理**：多用户支持，权限控制

### 1.2 技术栈

| 类别 | 技术 | 版本 |
|------|------|------|
| 主框架 | Electron | ^25.0.0 |
| 前端框架 | Vue.js | ^3.3.0 |
| 构建工具 | Vite | ^4.4.0 |
| UI 组件库 | Element Plus | ^2.3.0 |
| 状态管理 | Pinia | ^2.1.0 |
| 路由管理 | Vue Router | ^4.2.0 |
| HTTP 客户端 | Axios | ^1.5.0 |
| 数据库 | SQLite | ^5.0.0 |
| 日志库 | Winston | ^3.10.0 |

## 2. 系统架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                       澜鳐控制终端                               │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │    主进程       │  │    渲染进程     │  │    渲染进程     │  │
│  │  (Electron)     │  │  (Vue App)      │  │  (Vue App)      │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│          │                   │                   │              │
│          └───────────────────┼───────────────────┘              │
│                              ▼                                  │
│                      ┌─────────────────┐                        │
│                      │    IPC 通信     │                        │
│                      └─────────────────┘                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       澜鳐物联网网关                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   路由器模块    │  │   网关核心      │  │   设备管理      │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       物联网设备集群                              │
└─────────────────────────────────────────────────────────────────┘
```

### 2.1.1 局域网连接机制

澜鳐物联网网关具备路由器功能，可在无公网环境下独立运行，为连接的设备分配内网IP地址。

- **DHCP服务**：网关内置DHCP服务器，自动为连接的终端设备分配内网IP地址（默认网段：192.168.10.0/24）
- **自动发现**：终端软件启动后自动搜索局域网内的澜鳐网关，无需手动配置IP地址
- **静态IP支持**：支持手动配置静态IP地址，适应特殊网络环境
- **纯局域网运行**：所有通信均在局域网内完成，无需公网连接，确保数据安全性

### 2.1.2 适用场景

- **无网络环境**：如野外作业、临时搭建的物联网系统
- **保密环境**：如实验室、军工单位等要求主机不得连接公网的场景
- **隔离网络**：需要与公网物理隔离的工业控制系统

### 2.2 模块划分

| 模块 | 职责 | 技术实现 |
|------|------|----------|
| 主进程 | 应用生命周期管理、系统资源访问、IPC通信 | Electron |
| 渲染进程 | UI渲染、用户交互、业务逻辑 | Vue 3 + Element Plus |
| 设备管理 | 设备增删改查、状态同步 | Vue 组件 + Pinia |
| 设备控制 | 发送控制指令、接收设备响应 | Axios + WebSocket |
| 日志系统 | 日志记录、查询、分析 | Winston + SQLite |
| 网关管理 | 网关连接、配置、状态监控 | TCP/IP + WebSocket |
| 用户管理 | 用户认证、权限控制 | JWT + Pinia |

## 3. 项目结构

```
├── build/                    # 构建配置文件
│   ├── electron-builder.json # electron-builder 配置
│   └── vite.config.ts        # Vite 配置
├── dist/                     # 构建输出目录
├── electron/                 # Electron 主进程代码
│   ├── main.ts               # 主进程入口
│   ├── preload.ts            # 预加载脚本
│   ├── ipc/                  # IPC 通信模块
│   ├── logger/               # 日志模块
│   └── gateway/              # 网关通信模块
├── src/                      # Vue 渲染进程代码
│   ├── assets/               # 静态资源
│   ├── components/           # Vue 组件
│   ├── layouts/              # 布局组件
│   ├── pages/                # 页面组件
│   │   ├── DeviceControl/    # 设备控制页面
│   │   ├── DeviceManage/     # 设备管理页面
│   │   ├── Log/              # 日志页面
│   │   ├── Gateway/          # 网关管理页面
│   │   └── User/             # 用户管理页面
│   ├── router/               # 路由配置
│   ├── stores/               # Pinia 状态管理
│   ├── services/             # 业务服务
│   ├── utils/                # 工具函数
│   └── main.ts               # Vue 应用入口
├── public/                   # 公共资源
├── package.json              # 项目依赖
└── tsconfig.json             # TypeScript 配置
```

## 4. 核心功能实现

### 4.1 设备控制功能

#### 4.1.1 设备列表展示

- **实现方式**：使用 Element Plus 的 `el-table` 组件展示设备列表
- **数据来源**：从 Pinia store 中获取设备列表数据
- **主要功能**：
  - 设备状态实时更新
  - 设备分类筛选
  - 设备搜索
  - 设备快速控制

#### 4.1.2 设备控制界面

- **实现方式**：根据设备类型动态渲染不同的控制组件
- **支持设备类型**：
  - 开关型设备（灯、插座等）
  - 调节型设备（空调、窗帘等）
  - 传感器设备（温度、湿度传感器等）

#### 4.1.3 控制指令流程

```
1. 用户在界面上操作设备
2. Vue 组件触发控制事件
3. Pinia store 调用设备服务
4. 设备服务通过 IPC 向主进程发送控制指令
5. 主进程通过网关通信模块发送指令到网关
6. 网关转发指令到目标设备
7. 设备执行指令并返回结果
8. 网关将结果返回给主进程
9. 主进程通过 IPC 通知渲染进程
10. Pinia store 更新设备状态
11. Vue 组件更新 UI
```

### 4.2 日志功能

#### 4.2.1 日志类型

- **设备日志**：设备操作记录、状态变化记录
- **系统日志**：应用启动、关闭、错误信息等
- **网关日志**：网关连接状态、通信记录等

#### 4.2.2 日志存储

- **实现方式**：使用 Winston 记录日志到文件，同时将关键日志存储到 SQLite 数据库
- **日志文件路径**：`%APPDATA%/LanYaoTerminal/logs/`（Windows）或 `~/.config/LanYaoTerminal/logs/`（macOS/Linux）
- **数据库表结构**：
  ```sql
  CREATE TABLE logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    type TEXT NOT NULL,
    level TEXT NOT NULL,
    message TEXT NOT NULL,
    timestamp DATETIME NOT NULL,
    device_id TEXT,
    user_id TEXT
  );
  ```

#### 4.2.3 日志查询界面

- **实现方式**：使用 Element Plus 的 `el-table` 和 `el-pagination` 组件
- **查询功能**：
  - 按日志类型筛选
  - 按时间范围查询
  - 按设备 ID 查询
  - 按关键词搜索

### 4.3 网关管理功能

#### 4.3.1 网关自动发现

- **实现方式**：使用 UDP 广播实现网关自动发现
- **发现流程**：
  1. 终端软件启动后，在局域网内发送 UDP 广播包（端口：1900）
  2. 澜鳐网关收到广播包后，返回包含自身信息的响应
  3. 终端软件解析响应，获取网关 IP 地址、型号、版本等信息
  4. 在界面上显示发现的网关列表，供用户选择连接

#### 4.3.2 网关连接

- **实现方式**：使用 TCP/IP 协议与网关建立连接
- **连接方式**：
  - **自动连接**：选择自动发现的网关，一键连接
  - **手动连接**：手动输入网关 IP 地址和端口进行连接
  - **静态 IP 连接**：支持配置静态 IP 地址，适应特殊网络环境
- **连接流程**：
  1. 用户选择或输入网关连接信息
  2. 主进程尝试与网关建立 TCP 连接
  3. 连接成功后，进行身份验证
  4. 建立 WebSocket 连接用于实时通信
  5. 获取网关分配的内网 IP 地址（通过 DHCP）

#### 4.3.3 网关状态监控

- **实现方式**：通过心跳机制监控网关连接状态
- **心跳间隔**：30秒
- **状态展示**：在界面上显示网关在线/离线状态
- **网络信息展示**：显示网关分配的内网 IP 地址、子网掩码、网关地址等信息

#### 4.3.4 DHCP 配置

- **实现方式**：网关内置 DHCP 服务器，为连接的设备分配内网 IP 地址
- **默认配置**：
  - 网段：192.168.10.0/24
  - IP 地址范围：192.168.10.100 - 192.168.10.200
  - 子网掩码：255.255.255.0
  - 网关地址：192.168.10.1
  - DNS 服务器：192.168.10.1（网关内置 DNS 转发）
- **配置选项**：支持在网关管理界面修改 DHCP 配置参数

#### 4.3.5 纯局域网运行保障

- **数据隔离**：所有设备通信均在局域网内完成，不与公网交互
- **本地存储**：设备信息、操作日志等数据均存储在本地，不上传至云端
- **离线运行**：网关和终端软件均可在完全离线状态下正常运行
- **安全认证**：局域网内设备通信采用加密协议，确保数据安全

## 5. 开发与构建

### 5.1 开发环境搭建

1. 安装 Node.js（版本 >= 16.0.0）
2. 克隆项目代码
3. 安装依赖：
   ```bash
   npm install
   ```
4. 启动开发服务器：
   ```bash
   npm run dev
   ```

### 5.2 构建流程

1. 构建 Vue 应用：
   ```bash
   npm run build
   ```
2. 打包 Electron 应用：
   ```bash
   npm run electron:build
   ```
3. 构建产物位于 `dist/` 目录

### 5.3 开发规范

- **代码风格**：使用 ESLint + Prettier 进行代码检查和格式化
- **提交规范**：使用 Conventional Commits 规范
- **分支管理**：采用 Git Flow 工作流

## 6. 部署与维护

### 6.1 部署方式

- **Windows**：生成 `.exe` 安装包
- **macOS**：生成 `.dmg` 安装包
- **Linux**：生成 `.deb` 和 `.rpm` 安装包

### 6.2 无网络环境部署

- **离线安装包**：提供完整的离线安装包，包含所有依赖
- **离线更新**：支持通过 USB 等存储设备进行手动更新
- **本地许可证**：支持离线激活，无需联网验证

### 6.3 保密环境部署

- **纯离线运行**：所有功能均在本地运行，无任何公网通信
- **数据本地存储**：所有数据均存储在本地设备，不上传至云端
- **可审计日志**：提供详细的操作日志，便于审计和追溯
- **权限管理**：支持细粒度的权限控制，确保数据安全

### 6.4 版本更新

- **自动检查更新**：仅在连接公网时可用
- **手动更新**：支持通过离线安装包进行手动更新
- **更新日志展示**：显示版本更新内容

### 6.5 常见问题排查

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 无法发现网关 | 1. 网关未开机<br>2. 终端与网关不在同一局域网<br>3. 防火墙阻止了UDP广播 | 1. 检查网关电源<br>2. 确保终端与网关连接同一网络<br>3. 配置防火墙允许UDP端口1900 |
| 无法连接网关 | 1. 网关 IP 或端口错误<br>2. 网关 DHCP 服务异常<br>3. 网络线缆故障 | 1. 检查网关配置<br>2. 重启网关 DHCP 服务<br>3. 检查网络线缆 |
| 设备无响应 | 1. 设备离线<br>2. 网络连接不稳定<br>3. 设备与网关通信故障 | 1. 检查设备电源<br>2. 检查网络连接<br>3. 重启设备和网关 |
| 无法获取内网 IP | 1. 网关 DHCP 服务未开启<br>2. DHCP 地址池耗尽<br>3. 网络配置错误 | 1. 开启网关 DHCP 服务<br>2. 扩展 DHCP 地址池<br>3. 检查网络配置 |
| 应用崩溃 | 软件bug | 查看系统日志，提交issue |

## 7. 未来规划

### 7.1 功能扩展

- 支持更多设备类型
- 添加设备自动化场景
- 支持语音控制
- 添加数据统计与分析功能
- 支持远程控制（通过云服务）

### 7.2 性能优化

- 优化设备状态更新机制
- 减少内存占用
- 提高应用启动速度

### 7.3 安全性增强

- 加强数据加密
- 完善权限管理
- 添加设备认证机制

## 8. 附录

### 8.1 API 文档

#### 8.1.1 设备控制 API

| 接口名称 | 方法 | 参数 | 返回值 | 描述 |
|----------|------|------|--------|------|
| 设备开关控制 | POST | deviceId, status | { success: boolean, message: string } | 控制设备开关 |
| 设备参数调节 | POST | deviceId, params | { success: boolean, message: string } | 调节设备参数 |
| 获取设备状态 | GET | deviceId | { status: string, params: object } | 获取设备当前状态 |

#### 8.1.2 日志 API

| 接口名称 | 方法 | 参数 | 返回值 | 描述 |
|----------|------|------|--------|------|
| 获取日志列表 | GET | type, startTime, endTime, page, size | { logs: array, total: number } | 获取日志列表 |
| 清空日志 | DELETE | type | { success: boolean, message: string } | 清空指定类型日志 |

### 8.2 数据库设计

#### 8.2.1 设备表

```sql
CREATE TABLE devices (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  type TEXT NOT NULL,
  gateway_id TEXT NOT NULL,
  status TEXT NOT NULL,
  params TEXT,
  create_time DATETIME NOT NULL,
  update_time DATETIME NOT NULL
);
```

#### 8.2.2 网关表

```sql
CREATE TABLE gateways (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  ip TEXT NOT NULL,
  port INTEGER NOT NULL,
  status TEXT NOT NULL,
  create_time DATETIME NOT NULL,
  update_time DATETIME NOT NULL
);
```

#### 8.2.3 用户表

```sql
CREATE TABLE users (
  id TEXT PRIMARY KEY,
  username TEXT NOT NULL UNIQUE,
  password TEXT NOT NULL,
  role TEXT NOT NULL,
  create_time DATETIME NOT NULL,
  update_time DATETIME NOT NULL
);
```

## 9. 联系方式

- 项目地址：https://github.com/yourusername/LanYaoTerminal
- 问题反馈：https://github.com/yourusername/LanYaoTerminal/issues
